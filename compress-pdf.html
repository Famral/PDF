<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compress PDF - Smaller PDFs in your browser!</title>
    <meta name="description"
        content="Free, In-browser, Privacy friendly PDF Compressor. Your files doesn't leave your browser." />
    <link rel="icon" type="image/png" href="https://www.famral.com/favicon.png">
    <script defer src="js/pdfkit-standalone-0.10.0.js"></script>
    <script defer src="js/blob-stream-0.1.3.js"></script>
    <script src="js/pdf.min-2.5.207.js"></script>
    <script src="js/FileSaver.min-2.0.4.js"></script>
    <script src="js/sortable.min.1.10.2.js"></script>
</head>

<body>
    <style>
        :root {
            --primary: #3B82F6;
            --primary-hover: #2563EB;
            --secondary: #64748B;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --radius: 0.75rem;
            --text-base: #1E293B;
            --text-muted: #475569;
            --font-sans: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text-base);
            line-height: 1.5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 960px;
            width: 100%;
        }

        /*  New Header / Nav  */
        .header {
            background-color: var(--bg);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .navbar {
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--text-base);
        }

        .nav-logo {
            height: 2.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-logo img {
            display: block;
            height: 100%;
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-links li a {
            text-decoration: none;
            color: var(--text-base);
            font-weight: 500;
            transition: color 0.2s ease-in-out;
        }

        .nav-links li a:hover {
            color: var(--primary);
        }

        /*  Main Card  */
        .card {
            background-color: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            padding: 2rem;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .card {
                grid-template-columns: 1fr;
            }
        }

        /*  File Input Area  */
        .file-input-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .file-drop-zone {
            border: 2px dashed var(--secondary);
            border-radius: var(--radius);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .file-input {
            display: none;
        }

        .selected-files-info {
            font-size: 0.875rem;
        }

        /*  Settings and Controls  */
        .settings-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .range-input {
            width: 100%;
        }

        .compress-button {
            background-color: var(--primary);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .compress-button:hover {
            background-color: var(--primary-hover);
        }

        /*  File List Panel  */
        .file-list-panel {
            background-color: var(--bg);
            border-radius: var(--radius);
            padding: 1rem;
        }

        .file-list-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-list-item {
            background-color: var(--card);
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: grab;
        }

        .file-list-item:active {
            cursor: grabbing;
        }

        .drag-handle {
            cursor: grab;
        }

        /*  Footer  */
        .footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-muted);
            font-size: 0.75rem;
        }
    </style>

    <div class="container">
        <header class="header">
            <nav class="navbar">
                <a href="/" class="nav-brand">
                    <div class="nav-logo">
                        <img src="https://www.famral.com/logo.png" alt="Famral logo" />
                    </div>
                </a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                </ul>
            </nav>
        </header>

        <main class="card">
            <section class="file-input-area">
                <div class="file-drop-zone">
                    <p>Drag and drop PDF files here or click to select</p>
                    <input type="file" id="pdf_input" class="file-input" accept="application/pdf" multiple />
                </div>
                <div class="selected-files-info">Selected files: <span id="file_count">0</span></div>
            </section>

            <aside class="file-list-panel">
                <h2 class="file-list-title">Files to Compress</h2>
                <ul id="selected_pdf_list" class="file-list">
                    <!-- File list items will be dynamically added here -->
                </ul>
                <div id="status_text">Idle</div>
            </aside>
        </main>

        <section class="settings-panel">
            <div class="setting-item">
                <label for="compress_input" class="setting-label">Compression Ratio</label>
                <input type="range" id="compress_input" class="range-input" min="0" max="1" value="0.5" step="0.1" />
                <div id="compress_input_output">0.5</div>
            </div>
            <button id="compress_pdf" class="compress-button">Compress PDF</button>
        </section>

        <footer class="footer">
            <p>&copy; 2025 Famral.</p>
        </footer>
    </div>

    <div style="max-width:0; max-height:0; overflow:hidden">
        <canvas id="page_canvas"></canvas>
    </div>

    <script>
        function setLoading() {
            var compress_pdf = document.getElementById("compress_pdf");
            if (compress_pdf.style.animation == "none") {
                console.log("Loading...");
            } else {
                compress_pdf.style.animation = "loading 2s infinite";
            }
            compress_pdf.innerText = "Compressing...";
            compress_pdf.disabled = true;
        }

        function resetLoading() {
            var compress_pdf = document.getElementById("compress_pdf");
            compress_pdf.style.animation = "none";
            compress_pdf.disabled = false;
            compress_pdf.innerText = "Compress PDF";
        }

        function onPDFCompressed() {
            var pdf_input = document.getElementById("pdf_input");
            pdf_input.value = "";
            resetAll();
        }

        function resetAll() {
            resetTempArrays();
            //clearPDFList();
            resetLoading();
        }

        function addFileEntry(file_name) {
            var list = document.getElementById("selected_pdf_list");
            var entry = document.createElement("li");
            entry.classList.add("file-list-item");
            entry.style = "list-style: none; font-size: x-small;";
            var img = document.createElement('span');
            img.textContent = 'â˜°';
            img.classList.add("drag-handle");
            entry.append(img);
            var space = document.createTextNode("\u00A0");
            entry.append(space);
            entry.append(file_name);
            list.appendChild(entry);
        }

        var selected_pdf_list = document.getElementById("selected_pdf_list");
        var sortable_list = new Sortable(selected_pdf_list, {
            animation: 150,
            ghostClass: "ghost-class",
            handle: '.drag-handle',
            onSort: function (event) {
                updateFileListOnSort(event.to);
            },
        });

        var tenet = [];
        var fc = 0;

        var input_file_names = [];
        var ordered_input_files = [];
        var ordered_index = [];
        var sorted = false;

        var input_scale = 1,
            input_quality = 0.5,
            input_quality_ui = 0.5,
            input_format = "image/jpeg";

        var pdf_input = document.getElementById("pdf_input");
        pdf_input.addEventListener("input", onInputPDF);

        var compress_pdf = document.getElementById("compress_pdf");
        compress_pdf.addEventListener("click", onProcessInputPDF);

        var quality_input = document.getElementById("compress_input");
        quality_input.addEventListener("input", onQualityInput);

        function onQualityInput() {
            input_quality_ui = Number(this.value);
            var output_quality = document.getElementById("compress_input_output");
            output_quality.innerText = input_quality_ui;
            input_quality = 1 - input_quality_ui;
        }

        function resetTempArrays() {
            input_file_names = [];
            ordered_input_files = [];
            ordered_index = [];
            sorted_file_names = [];
            tenet = [];
            sorted = false;
        }

        function onInputPDF() {
            resetTempArrays();
            clearPDFList();

            fc = this.files.length;

            for (i = 0; i < fc; i++) {
                var file = this.files[i];

                if (!file) {
                    return;
                }

                if (file.type != "application/pdf") {
                    pdfName = null;
                    pdfFileObject = null;
                    console.log(
                        file.name + " - Unsupported file format, Select a PDF file!!"
                    );
                    selected_file_name = file.name + " - Unsupported file format!!";
                    alert(selected_file_name);
                    return;
                }
            }

            ordered_input_files = Array.from(this.files);

            for (j = 0; j < fc; j++) {
                input_file_names.push(this.files[j]["name"]);
            }

            generateFileList();
        }

        function generateFileList() {
            for (i = 0; i < ordered_input_files.length; i++) {
                addFileEntry(ordered_input_files[i]["name"]);
            }
        }

        function compareFileLists(oldList, newList) {
            var indexList = [];
            var i = 0,
                len = oldList.length;
            while (i < len) {
                indexList.push(newList.indexOf(oldList[i]));
                i++;
            }

            return indexList;
        }

        function sortFiles(fileListRef, sortedIndex) {
            var fileList = Array.from(fileListRef);
            var i = 0;
            len = sortedIndex.length;

            while (i < len) {
                while (sortedIndex[i] != i) {
                    var currTgtIdx = sortedIndex[sortedIndex[i]];
                    var currTgtData = fileList[sortedIndex[i]];

                    sortedIndex[sortedIndex[i]] = sortedIndex[i];
                    fileList[sortedIndex[i]] = fileList[i];

                    sortedIndex[i] = currTgtIdx;
                    fileList[i] = currTgtData;
                }
                i++;
            }
            return fileList;
        }

        function updateFileListOnSort(file_list_div) {
            sorted_file_names = [];
            var items = file_list_div.childNodes;
            for (i = 0; i < items.length; i++) {
                sorted_file_names.push(items[i].textContent.trim());
            }

            var finalIndex = compareFileLists(input_file_names, sorted_file_names);
            ordered_index = Array.from(finalIndex);
        }

        function clearPDFList() {
            var list = document.getElementById("selected_pdf_list");
            list.textContent = "";
        }

        function generateMetadata(file) {
            pdfName = file["name"];
            pdfFileObject = file;
            selected_file_name = pdfName;
        }

        function getFileToProcessed() {
            return ordered_input_files.shift();
        }

        function checkFileProcessProgress() {
            if (ordered_input_files.length == 0) {
                processImageData();
            } else {
                onProcessInputPDF();
            }
        }

        function checkFiles() {
            return ordered_input_files.length;
        }

        function sortFileList() {
            if (!sorted) {
                var sorted_files = sortFiles(ordered_input_files, ordered_index);
                ordered_input_files = Array.from(sorted_files);
                sorted = true;
            }
        }

        function onProcessInputPDF() {
            if (!checkFiles()) {
                alert("Select PDF Files to Compress ðŸ™‚");
                return;
            }

            setLoading();

            sortFileList();

            var file = getFileToProcessed();

            if (file) {
                generateMetadata(file);
            } else {
                return;
            }

            if (!pdfFileObject) {
                return;
            }

            console.log("Loading selected file: " + pdfName);

            const reader = new FileReader();

            reader.onload = function (e) {
                var url = e.target.result;
                pdf2img(url);
            };
            if (pdfFileObject) {
                reader.readAsDataURL(pdfFileObject);
            } else {
                console.log(
                    "Error reading file: " + pdfName + " Choose file(s) again..."
                );
            }
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = "js/pdf.worker.min-2.5.207.js";

        var pdfDoc = null,
            pageNum = 1,
            pdfFileObject = null,
            pageRendering = false,
            pageCount = 0,
            pageNumPending = null,
            pageScale = input_scale,
            pageQuality = input_quality,
            pageQualityUI = input_quality_ui,
            pageFormat = input_format,
            imgData = null,
            pdfName = "doc",
            selected_file_name = "";

        var canvas = document.getElementById("page_canvas");
        var ctx = canvas.getContext("2d");

        function pdf2img(pdf_url) {
            readPDF(pdf_url).then(
                () => downloadAll(),
                () => {
                    console.log("Error reading PDF... May be an encrypted one [-_^]");
                }
            );
        }

        function readPDF(url) {
            return new Promise((resolve, reject) => {
                var loadingTask = pdfjsLib.getDocument(url);
                loadingTask.promise.then(
                    function (pdfDoc_) {
                        pdfDoc = pdfDoc_;
                        resetPDFMetaStore(pdfDoc.numPages);
                        console.log("PDF Loaded: " + pdfName);
                        selected_file_name += " - " + pageCount + " Pages";
                        resolve(1);
                    },
                    () => reject(1)
                );
            });
        }

        function resetPDFMetaStore(numPages) {
            pageCount = numPages;
            imgData = {};
            pageNumPending = [];
            pageScale = input_scale;
            pageQuality = input_quality;
            pageQualityUI = input_quality_ui;
            pageFormat = input_format;
        }

        function getOutputPdfName() {
            if (fc == 1) {
                return pdfName.split(".pdf")[0] + "_min_" + pageQualityUI + ".pdf";
            } else {
                return "Comb_Doc" + "_min_" + pageQualityUI + ".pdf";
            }
        }

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function (page) {
                var viewport = page.getViewport({
                    scale: pageScale
                });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                };
                var renderTask = page.render(renderContext);

                renderTask.promise.then(function () {
                    data = canvas.toDataURL(pageFormat, pageQuality);

                    imgData[num] = data;
                    console.log("Completed page: " + num);
                    pageRendering = false;

                    if (pageNumPending !== null && pageNumPending.length != 0) {
                        renderPage(pageNumPending.shift());
                    } else {
                        if (Object.keys(imgData).length == pageCount) {
                            tenet.push(JSON.parse(JSON.stringify(imgData)));
                            console.log("Rendering complete");
                            checkFileProcessProgress();
                        }
                    }
                });
            });

            console.log("Processing page: " + num);
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending.push(num);
            } else {
                renderPage(num);
            }
        }

        function downloadAll() {
            for (i = 1; i <= pageCount; i++) {
                queueRenderPage(i);
            }
        }

        function getImgObj(data) {
            return new Promise(function (resolve, reject) {
                var img = new Image();
                img.onload = function () {
                    resolve(img);
                };
                img.src = data;
            });
        }

        async function processImageData() {
            var options = {
                autoFirstPage: false,
                compress: false,
            };

            const doc = new PDFDocument(options);

            doc.info = {
                Title: "Final_Doc.pdf",
                Author: "Famral",
                Keywords: "Famral PDF Editor",
            };
            const stream = doc.pipe(blobStream());

            for (let k = 0; k < tenet.length; k++) {
                var imgData = tenet[k];
                console.log("PDF %d: %d pages", k + 1, Object.keys(imgData).length);

                for (let i = 1; i <= Object.keys(imgData).length; i++) {
                    img_data = await getImgObj(imgData[i]);
                    doc.addPage({
                        size: [img_data.width, img_data.height],
                    });
                    doc.image(img_data.src, 0, 0);
                }
            }

            doc.end();

            stream.on("finish", function () {
                var output_blob = stream.toBlob("application/pdf");
                saveAs(output_blob, getOutputPdfName());
                onPDFCompressed();
            });
        }

        // small UI helpers to keep script behavior intact
        (function () {
            var pdfInput = document.getElementById('pdf_input');
            var fileCount = document.getElementById('file_count');
            var statusText = document.getElementById('status_text');
            var compressBtn = document.getElementById('compress_pdf');
            var compressInput = document.getElementById('compress_input');
            var compressInputOutput = document.getElementById('compress_input_output');

            pdfInput.addEventListener('change', function () {
                fileCount.innerText = this.files ? this.files.length : 0;
                statusText.innerText = this.files && this.files.length ? 'Ready' : 'Idle';
            });

            compressInput.addEventListener('input', function () {
                compressInputOutput.innerText = this.value;
            });

            var origSetLoading = window.setLoading;
            var origResetLoading = window.resetLoading;
            window.setLoading = function () {
                statusText.innerText = 'Compressingâ€¦';
                if (typeof origSetLoading === 'function') origSetLoading();
            };
            window.resetLoading = function () {
                statusText.innerText = 'Idle';
                if (typeof origResetLoading === 'function') origResetLoading();
            };
        })();
    </script>
</body>

</html>
